# ============================================================
# 示例1: CRON 定时触发的数据治理 DAG
# 每日凌晨2点提取作业周期数据并执行治理
# ============================================================

source_meta:
  id: "daily_cycle_etl"
  name: "每日作业周期数据提取"
  description: "从MySQL提取作业周期数据，执行数据质量检查和资产识别"
  target_entity: "Cycle"  # 目标实体类型，系统会自动加载 adapters/cycle_adapter.yaml
  owner: "box_admin"
  tags: ["production", "daily", "cycle"]

# 调度策略
scheduling:
  trigger_mode: "CRON"
  cron_expression: "0 2 * * *"  # 每天凌晨2点
  
  # 可选：前置传感器，确保上游数据就绪
  sensor:
    enabled: true
    type: "SQL"
    sql: |
      SELECT COUNT(*) >= 100
      FROM cycle_section_summary
      WHERE DATE(end_time) = CURDATE()
    conn_id: "datalog_mysql_conn"
    timeout: 1800      # 30分钟超时
    poke_interval: 300  # 每5分钟检查一次
    mode: "reschedule"  # 释放worker slot

# 数据提取配置（支持多数据源）
extractions:
  - id: "raw_cycle_section"
    source_type: "mysql"
    conn_id: "datalog_mysql_conn"
    query: |
      SELECT 
        cycle_id,
        vehicle_id,
        start_time,
        end_time,
        TIMESTAMPDIFF(SECOND, start_time, end_time) AS duration,
        section_type,
        task_id
      FROM cycle_section_summary
      WHERE DATE(end_time) = '{{ ds }}'
        AND status = 'COMPLETED'
    output_key: "raw_cycle_section"

  - id: "raw_vehicle_cycle"
    source_type: "mysql"
    conn_id: "datalog_mysql_conn"
    query: |
      SELECT
        cycle_id,
        twin_lift,
        box_count,
        shift_date
      FROM subtarget_vehicle_cycle
      WHERE DATE(shift_date) = '{{ ds }}'
    output_key: "raw_vehicle_cycle"

# 可选：覆盖全局 default_args
default_args:
  retries: 3
  retry_delay_minutes: 10
  email: ["data-team@example.com", "box_admin@example.com"]
