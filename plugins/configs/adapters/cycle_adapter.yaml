# cycle_adapter.yaml
# 领域适配器配置文件
#
# 功能：将原始数据映射为领域实体（Cycle）
# 使用者：DomainAdapterOperator

# 目标实体
target_entity: "Cycle"

# 输出键（写入 Context 的 key）
output_key: "entity_cycle"

# 输入数据架构
input_schema:
  # 主表（必需）
  primary_source: "raw_cycle_section"  # 引用 Loader 写入的数据
  
  # Join 配置（可选）
  joins:
    - join_source: "raw_vehicle_cycle"  # 要 Join 的数据源
      type: "left"                      # Join 类型: left, inner, outer
      left_on: "cycle_id"               # 左表连接字段
      right_on: "cycle_id"              # 右表连接字段（sources.yaml 中已重命名）
      suffix: "_vehicle"                # 右表字段后缀（防止列名冲突）

# 字段映射（列表格式，每个字段一个配置）
fields:
  # 1. 直接映射字段（从主表 section）
  - target: "cycle_id"
    source_expr: "col('cycle_id')"
  
  - target: "vehicle_id"
    source_expr: "col('vehicle_id')"
  
  - target: "start_time"
    source_expr: "col('start_time')"
  
  - target: "end_time"
    source_expr: "col('end_time')"
  
  - target: "duration"
    source_expr: "col('duration')"
  
  - target: "task_type"
    source_expr: "col('task_type')"
  
  # 2. 从 Join 的右表获取字段（vehicle 表）
  # 注意：如果字段名不重复，Polars 不会添加后缀
  - target: "is_twin_lift"
    source_expr: "col('is_twin_lift').fill_null(0)"  # 处理空值
  
  - target: "box_count"
    source_expr: "col('box_count').fill_null(0)"     # 处理空值
  
  # 3. 扩展属性（JSON 格式）
  - target: "extra_attributes"
    source_expr: "lit('{}')"  # 空字典，暂无扩展属性

# 数据清洗规则（在映射之前应用，可选）
# 注意：当前版本代码中可能未实现此功能，如遇错误可删除此段
# data_cleaning:
#   drop_duplicates:
#     - cycle_id
#   drop_nulls:
#     - cycle_id
#     - start_time
#     - end_time
#   fill_nulls:
#     is_twin_lift: 0
#     box_count: 0
#     task_type: "UNKNOWN"
