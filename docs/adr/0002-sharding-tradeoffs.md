# ADR 002: 分片策略对逻辑校验的影响与权衡 (Trade-off)

- **状态**: 已采纳 (Accepted)
- **日期**: 2025-12-10
- **决策人**: Joy Zhou
- **标签**: #数据质量 #统计学 #分片副作用

## 1. 背景 (Context)
引入 ID 分片策略后，数据处理从“全局视图”变为“局部视图”。这破坏了部分依赖全局上下文或时间连续性的数据质量规则。需明确其影响范围并确认业务可接受度。

## 2. 影响分析 (Analysis)

### 2.1 连续性检查 (Chain Continuity)
- **规则**: 检查同一实体的作业链是否连续（如 `cnt_newcycles` 的车辆作业）。
- **影响**: 分片边界处的数据可能会“断链”，即分片 B 的第一条记录找不到分片 A 的最后一条记录，导致漏测。
- **现状**: `cnt_newcycles` 暂维持 **单表全量模式**，不受影响。若未来启用分片，需引入 Reduce 阶段合并检测或按 Hash 分片。

### 2.2 统计分布检查 (Statistical Distribution)
- **规则**: 3-Sigma 异常检测（如 `cnt_cycles` 作业时长）。
- **影响**: 均值（Mean）和标准差（StdDev）由“全局计算”变为“分片内局部计算”。
- **分析**:
    - 如果数据分布随 ID（时间）变化剧烈（如早高峰与夜间作业差异大），局部统计可能更精准反映该时间段的异常。
    - 如果数据分布均匀，由于 `BATCH_SIZE=50,000` 样本量充足，局部统计值与全局近似。
- **结论**: 接受“局部 3-Sigma”作为一种近似解，其在工程性能与统计严谨性之间取得了合理平衡。

## 3. 决策 (Decision)
1.  **单表连续性任务**：暂时不启用分片，维持全量拉取以保证逻辑正确性。
2.  **统计类任务**：接受分片内的局部统计结果。在代码注释中明确此行为差异。
3.  **时区缓冲**：将跨库查询的时间窗口缓冲 (`buffer`) 提取为可配置项 (`TIME_WINDOW_BUFFER_HOURS`)，默认 3 小时，以应对潜在的时区配置错误。

## 4. 未来工作 (Future Work)
若后续业务对全局统计精度有严格要求，可参考以下主流方案进行架构演进：

### 4.1 方案 A：Map-Reduce (流式/两阶段计算) - 精确解
- **原理**：利用 Welford 算法或 Map-Reduce 范式。
- **流程**：
    1.  **Map (Worker)**：各分片不进行判定，仅返回中间统计量（Count, Sum, SumSquares）和潜在异常候选集（Top N）。
    2.  **Reduce (Master)**：合并中间统计量，计算精确的全局 Mean 和 StdDev。
    3.  **判定**：Master 使用全局阈值对候选集进行最终判定（避免二次拉取数据）。
- **适用场景**：必须获取精确全局统计值的场景。

### 4.2 方案 B：蓄水池采样 (Reservoir Sampling) - 推荐解
- **原理**：大数定律。
- **流程**：
    1.  **采样任务**：在分片任务前，先随机采样一小部分数据（如 10万条）。
    2.  **计算阈值**：基于采样数据计算全局 Mean/StdDev，作为广播变量。
    3.  **分片检查**：各分片 Worker 使用该全局阈值进行并行判定。
- **优势**：工程侵入性最小，性能开销低，且统计误差在工业场景可接受。

### 4.3 方案 C：数仓下推 (Push-down)
- **原理**：利用数据库自身的计算能力。
- **流程**：Master 先执行 SQL (`SELECT AVG, STDDEV ...`) 获取全局阈值，再分发给 Worker。
- **前提**：底层数据库（如 ClickHouse/StarRocks）具备高性能聚合能力，且对业务库负载影响可控。
